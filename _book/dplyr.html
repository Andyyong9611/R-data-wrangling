<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 Data Manipulation using dplyr | Data Wrangling with R</title>
  <meta name="description" content="Workshop materials for Data Wrangling with R" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 Data Manipulation using dplyr | Data Wrangling with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Workshop materials for Data Wrangling with R" />
  <meta name="github-repo" content="cengel/R-data-wrangling" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 Data Manipulation using dplyr | Data Wrangling with R" />
  
  <meta name="twitter:description" content="Workshop materials for Data Wrangling with R" />
  

<meta name="author" content="Claudia A Engel" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="tidyr.html"/>
<script src="libs/header-attrs-2.5/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Wrangling with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites and Preparations</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#references"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="dplyr.html"><a href="dplyr.html"><i class="fa fa-check"></i><b>1</b> Data Manipulation using <strong><code>dplyr</code></strong></a>
<ul>
<li class="chapter" data-level="1.1" data-path="dplyr.html"><a href="dplyr.html#what-is-dplyr"><i class="fa fa-check"></i><b>1.1</b> What is <strong><code>dplyr</code></strong>?</a></li>
<li class="chapter" data-level="1.2" data-path="dplyr.html"><a href="dplyr.html#subsetting-columns-and-rows"><i class="fa fa-check"></i><b>1.2</b> Subsetting columns and rows</a></li>
<li class="chapter" data-level="1.3" data-path="dplyr.html"><a href="dplyr.html#pipes"><i class="fa fa-check"></i><b>1.3</b> Pipes</a></li>
<li class="chapter" data-level="1.4" data-path="dplyr.html"><a href="dplyr.html#add-new-columns"><i class="fa fa-check"></i><b>1.4</b> Add new columns</a></li>
<li class="chapter" data-level="1.5" data-path="dplyr.html"><a href="dplyr.html#what-is-split-apply-combine"><i class="fa fa-check"></i><b>1.5</b> What is split-apply-combine?</a></li>
<li class="chapter" data-level="1.6" data-path="dplyr.html"><a href="dplyr.html#tallying"><i class="fa fa-check"></i><b>1.6</b> Tallying</a></li>
<li class="chapter" data-level="1.7" data-path="dplyr.html"><a href="dplyr.html#joining-two-tables"><i class="fa fa-check"></i><b>1.7</b> Joining two tables</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyr.html"><a href="tidyr.html"><i class="fa fa-check"></i><b>2</b> Data Manipulation using <strong><code>tidyr</code></strong></a>
<ul>
<li class="chapter" data-level="2.1" data-path="tidyr.html"><a href="tidyr.html#about-long-and-wide-table-format"><i class="fa fa-check"></i><b>2.1</b> About long and wide table format</a></li>
<li class="chapter" data-level="2.2" data-path="tidyr.html"><a href="tidyr.html#long-to-wide-with-pivot_wider"><i class="fa fa-check"></i><b>2.2</b> Long to Wide with <code>pivot_wider</code></a></li>
<li class="chapter" data-level="2.3" data-path="tidyr.html"><a href="tidyr.html#wide-to-long-with-pivot_longer"><i class="fa fa-check"></i><b>2.3</b> Wide to long with <code>pivot_longer</code></a></li>
<li class="chapter" data-level="2.4" data-path="tidyr.html"><a href="tidyr.html#exporting-data"><i class="fa fa-check"></i><b>2.4</b> Exporting data</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Wrangling with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dplyr" class="section level1" number="1">
<h1><span class="header-section-number">Chapter 1</span> Data Manipulation using <strong><code>dplyr</code></strong></h1>
<blockquote>
<p>Learning Objectives</p>
<ul>
<li>Select columns in a data frame with the <strong><code>dplyr</code></strong> function <code>select</code>.</li>
<li>Select rows in a data frame according to filtering conditions with the <strong><code>dplyr</code></strong> function <code>filter</code>.</li>
<li>Direct the output of one <strong><code>dplyr</code></strong> function to the input of another function with the ‘pipe’ operator <code>%&gt;%</code>.</li>
<li>Add new columns to a data frame that are functions of existing columns with <code>mutate</code>.</li>
<li>Understand the split-apply-combine concept for data analysis.</li>
<li>Use <code>summarize</code>, <code>group_by</code>, and <code>count</code> to split a data frame into groups of observations, apply a summary statistics for each group, and then combine the results.</li>
<li>Join two tables by a common variable.</li>
</ul>
</blockquote>
<hr />
<p>Manipulation of data frames is a common task when you start exploring your data in R and <strong><code>dplyr</code></strong> is a package for making tabular data manipulation easier.</p>
<blockquote>
<p>Brief recap:
Packages in R are sets of additional functions that let you do more stuff. Functions like <code>str()</code> or <code>data.frame()</code>, come built into R; packages give you access to more of them. Before you use a package for the first time you need to install it on your machine, and then you should import it in every subsequent R session when you need it.</p>
</blockquote>
<p>If you haven’t, please install the <strong><code>tidyverse</code></strong> package.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="dplyr.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)    </span></code></pre></div>
<p><strong><code>tidyverse</code></strong> is an “umbrella-package” that installs a series of packages useful for data analysis which work together well. Some of them are considered <strong>core</strong> packages (among them <strong><code>tidyr</code></strong>, <strong><code>dplyr</code></strong>, <strong><code>ggplot2</code></strong>), because you are likely to use them in almost every analysis. Other packages, like <code>lubridate</code> (to work wiht dates) or <code>haven</code> (for SPSS, Stata, and SAS data) that you are likely to use not for every analysis are also installed.</p>
<p>If you type the following command, it will load the <strong>core</strong> <code>tidyverse</code> packages.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="dplyr.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tidyverse&quot;</span>)    <span class="do">## load the core tidyverse packages, incl. dplyr</span></span></code></pre></div>
<p>If you need to use functions from <code>tidyverse</code> packages other than the core packages, you will need to load them separately.</p>
<div id="what-is-dplyr" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> What is <strong><code>dplyr</code></strong>?</h2>
<p><strong><code>dplyr</code></strong> is one part of a larger <strong><code>tidyverse</code></strong> that enables you to work
with data in tidy data formats. “Tidy datasets are easy to manipulate, model and visualise, and have a specific structure: each variable is a column, each observation is a row, and each type of observational unit is a table.” (From Wickham, H. (2014): Tidy Data <a href="https://www.jstatsoft.org/article/view/v059i10" class="uri">https://www.jstatsoft.org/article/view/v059i10</a>)</p>
<p>The package <strong><code>dplyr</code></strong> provides convenient tools for the most common data manipulation
tasks. It is built to work directly with data frames, with many common tasks
optimized by being written in a compiled language (C++). An additional feature is the
ability to work directly with data stored in an external database. The benefits of
doing this are that the data can be managed natively in a relational database,
queries can be conducted on that database, and only the results of the query are
returned.</p>
<p>This addresses a common problem with R in that all operations are conducted
in-memory and thus the amount of data you can work with is limited by available
memory. The database connections essentially remove that limitation in that you
can have a database of many 100s GB, conduct queries on it directly, and pull
back into R only what you need for analysis.</p>
<p>To learn more about <strong><code>dplyr</code></strong> after the workshop, you may want to check out the <a href="https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf">handy data transformation with <strong><code>dplyr</code></strong> cheatsheet</a>.</p>
</div>
<div id="subsetting-columns-and-rows" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Subsetting columns and rows</h2>
<p>Let’s begin with loading our sample data into a data frame.</p>
<p>We will be working a small subset of the data from the <a href="https://openpolicing.stanford.edu">Stanford Open Policing Project</a>. It contains information about traffic stops for blacks and whites in the state of Mississippi during January 2013 to mid-July of 2016.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="dplyr.html#cb6-1" aria-hidden="true" tabindex="-1"></a>stops <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/MS_trafficstops_bw_age.csv&quot;</span>)</span></code></pre></div>
<pre><code>#&gt; Parsed with column specification:
#&gt; cols(
#&gt;   id = col_character(),
#&gt;   stop_date = col_date(format = &quot;&quot;),
#&gt;   county_name = col_character(),
#&gt;   county_fips = col_double(),
#&gt;   police_department = col_character(),
#&gt;   driver_gender = col_character(),
#&gt;   driver_birthdate = col_date(format = &quot;&quot;),
#&gt;   driver_race = col_character(),
#&gt;   officer_id = col_character(),
#&gt;   driver_age = col_double(),
#&gt;   violation = col_character()
#&gt; )</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="dplyr.html#cb8-1" aria-hidden="true" tabindex="-1"></a>stops</span></code></pre></div>
<pre><code>#&gt; # A tibble: 211,211 x 11
#&gt;    id    stop_date  county_name county_fips police_departme… driver_gender
#&gt;    &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;        
#&gt;  1 MS-2… 2013-01-01 Jones             28067 Mississippi Hig… male         
#&gt;  2 MS-2… 2013-01-01 Lauderdale        28075 Mississippi Hig… male         
#&gt;  3 MS-2… 2013-01-01 Pike              28113 Mississippi Hig… male         
#&gt;  4 MS-2… 2013-01-01 Hancock           28045 Mississippi Hig… male         
#&gt;  5 MS-2… 2013-01-01 Holmes            28051 Mississippi Hig… male         
#&gt;  6 MS-2… 2013-01-01 Jackson           28059 Mississippi Hig… female       
#&gt;  7 MS-2… 2013-01-01 Jackson           28059 Mississippi Hig… female       
#&gt;  8 MS-2… 2013-01-01 Grenada           28043 Mississippi Hig… female       
#&gt;  9 MS-2… 2013-01-01 Holmes            28051 Mississippi Hig… male         
#&gt; 10 MS-2… 2013-01-01 Holmes            28051 Mississippi Hig… male         
#&gt; # … with 211,201 more rows, and 5 more variables: driver_birthdate &lt;date&gt;,
#&gt; #   driver_race &lt;chr&gt;, officer_id &lt;chr&gt;, driver_age &lt;dbl&gt;, violation &lt;chr&gt;</code></pre>
<p>You may have noticed that by using <code>read_csv</code> we have generated an object
of class <code>tbl_df</code>, also known as a “tibble.” Tibble’s data
structure is very similar to a data frame. For our purposes the only differences
are that</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>columns of class <code>character</code> are never converted into factors<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>,</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>it tries to recognize and <code>date</code> types</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>the output displays the data type of each column under its name, and</li>
</ol></li>
<li><ol start="4" style="list-style-type: decimal">
<li>it only prints the first few rows of data and only as many columns as
fit on one screen. If we wanted to print all columns we can use the print command, and set the <code>width</code> parameter to <code>Inf</code>. To print the first 6 rows for example we would do this: <code>print(my_tibble, n=6, width=Inf)</code>.</li>
</ol></li>
</ul>
<p>To select columns of a
data frame with <code>dplyr</code>, use <code>select()</code>. The first argument to this function is the data
frame (<code>stops</code>), and the subsequent arguments are the columns to keep.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="dplyr.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(stops, police_department, officer_id, driver_race)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 211,211 x 3
#&gt;    police_department          officer_id driver_race
#&gt;    &lt;chr&gt;                      &lt;chr&gt;      &lt;chr&gt;      
#&gt;  1 Mississippi Highway Patrol J042       Black      
#&gt;  2 Mississippi Highway Patrol B026       Black      
#&gt;  3 Mississippi Highway Patrol M009       Black      
#&gt;  4 Mississippi Highway Patrol K035       White      
#&gt;  5 Mississippi Highway Patrol D028       White      
#&gt;  6 Mississippi Highway Patrol K023       White      
#&gt;  7 Mississippi Highway Patrol K032       White      
#&gt;  8 Mississippi Highway Patrol D021       White      
#&gt;  9 Mississippi Highway Patrol R021       White      
#&gt; 10 Mississippi Highway Patrol R021       White      
#&gt; # … with 211,201 more rows</code></pre>
<p>It is worth knowing that <code>dplyr</code> is backed by another package with a number of helper functions, which provide convenient functions to select columns based on their names. For example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="dplyr.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(stops, <span class="fu">starts_with</span>(<span class="st">&quot;driver&quot;</span>))</span></code></pre></div>
<pre><code>#&gt; # A tibble: 211,211 x 4
#&gt;    driver_gender driver_birthdate driver_race driver_age
#&gt;    &lt;chr&gt;         &lt;date&gt;           &lt;chr&gt;            &lt;dbl&gt;
#&gt;  1 male          1950-06-14       Black               63
#&gt;  2 male          1967-04-06       Black               46
#&gt;  3 male          1974-04-15       Black               39
#&gt;  4 male          1981-03-23       White               32
#&gt;  5 male          1992-08-03       White               20
#&gt;  6 female        1960-05-02       White               53
#&gt;  7 female        1953-03-16       White               60
#&gt;  8 female        1993-06-14       White               20
#&gt;  9 male          1947-12-11       White               65
#&gt; 10 male          1984-07-14       White               28
#&gt; # … with 211,201 more rows</code></pre>
<p>Check out the <a href="https://tidyselect.r-lib.org/reference/language.html">tidyselect reference</a> for more.</p>
<p>To subset rows based on specific criteria, we use <code>filter()</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="dplyr.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(stops, county_name <span class="sc">==</span> <span class="st">&quot;Yazoo&quot;</span>)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 3,528 x 11
#&gt;    id    stop_date  county_name county_fips police_departme… driver_gender
#&gt;    &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;        
#&gt;  1 MS-2… 2013-01-02 Yazoo             28163 Mississippi Hig… male         
#&gt;  2 MS-2… 2013-01-02 Yazoo             28163 Mississippi Hig… female       
#&gt;  3 MS-2… 2013-01-02 Yazoo             28163 Mississippi Hig… male         
#&gt;  4 MS-2… 2013-01-02 Yazoo             28163 Mississippi Hig… female       
#&gt;  5 MS-2… 2013-01-02 Yazoo             28163 Mississippi Hig… male         
#&gt;  6 MS-2… 2013-01-03 Yazoo             28163 Mississippi Hig… male         
#&gt;  7 MS-2… 2013-01-03 Yazoo             28163 Mississippi Hig… male         
#&gt;  8 MS-2… 2013-01-04 Yazoo             28163 Mississippi Hig… male         
#&gt;  9 MS-2… 2013-01-04 Yazoo             28163 Mississippi Hig… male         
#&gt; 10 MS-2… 2013-01-04 Yazoo             28163 Mississippi Hig… female       
#&gt; # … with 3,518 more rows, and 5 more variables: driver_birthdate &lt;date&gt;,
#&gt; #   driver_race &lt;chr&gt;, officer_id &lt;chr&gt;, driver_age &lt;dbl&gt;, violation &lt;chr&gt;</code></pre>
<p>Here are some other ways to subset rows:</p>
<ul>
<li>by row number: <code>slice(stops, 1:3) # rows 1-3</code></li>
<li>rows with highest or lowest values of a variable:
<ul>
<li><code>slice_min(stops, driver_age) # likewise slice_max()</code></li>
</ul></li>
<li>random rows:
<ul>
<li><code>slice_sample(stops, n = 5) # number of rows to select</code></li>
<li><code>slice_sample(stops, prop = .0001) # fraction of rows to select</code></li>
</ul></li>
</ul>
<p>To sort rows by variables use the <code>arrange</code> function:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="dplyr.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(stops, county_name, stop_date)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 211,211 x 11
#&gt;    id    stop_date  county_name county_fips police_departme… driver_gender
#&gt;    &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;        
#&gt;  1 MS-2… 2013-02-09 Adams             28001 Mississippi Hig… male         
#&gt;  2 MS-2… 2013-03-02 Adams             28001 Mississippi Hig… female       
#&gt;  3 MS-2… 2013-03-16 Adams             28001 Mississippi Hig… female       
#&gt;  4 MS-2… 2013-03-20 Adams             28001 Mississippi Hig… female       
#&gt;  5 MS-2… 2013-04-06 Adams             28001 Mississippi Hig… female       
#&gt;  6 MS-2… 2013-04-13 Adams             28001 Mississippi Hig… female       
#&gt;  7 MS-2… 2013-04-19 Adams             28001 Mississippi Hig… female       
#&gt;  8 MS-2… 2013-04-21 Adams             28001 Mississippi Hig… female       
#&gt;  9 MS-2… 2013-04-24 Adams             28001 Mississippi Hig… male         
#&gt; 10 MS-2… 2013-04-24 Adams             28001 Mississippi Hig… male         
#&gt; # … with 211,201 more rows, and 5 more variables: driver_birthdate &lt;date&gt;,
#&gt; #   driver_race &lt;chr&gt;, officer_id &lt;chr&gt;, driver_age &lt;dbl&gt;, violation &lt;chr&gt;</code></pre>
</div>
<div id="pipes" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Pipes</h2>
<p>What if you wanted to filter <strong>and</strong> select on the same data? For example, lets find drivers over 85 years and only keep the violation and gender columns. There are three ways to do this: use intermediate steps, nested functions, or pipes.</p>
<ul>
<li>Intermediate steps:</li>
</ul>
<p>With intermediate steps, you essentially create a temporary data frame and use
that as input to the next function. This can clutter up your workspace with lots
of objects.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="dplyr.html#cb18-1" aria-hidden="true" tabindex="-1"></a>tmp_df <span class="ot">&lt;-</span> <span class="fu">filter</span>(stops, driver_age <span class="sc">&gt;</span> <span class="dv">85</span>)</span>
<span id="cb18-2"><a href="dplyr.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tmp_df, violation, driver_gender)</span></code></pre></div>
<ul>
<li>Nested functions</li>
</ul>
<p>You can also nest functions (i.e. placce one function inside of another).
This is handy, but can be difficult to read if too many functions are nested as things are evaluated from the inside out.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="dplyr.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(<span class="fu">filter</span>(stops, driver_age <span class="sc">&gt;</span> <span class="dv">85</span>), violation, driver_gender)</span></code></pre></div>
<ul>
<li>Pipes!</li>
</ul>
<p>The last option, called “pipes.” Pipes let you take
the output of one function and send it directly to the next, which is useful
when you need to do many things to the same dataset. Pipes in R look like
<code>%&gt;%</code> and are made available via the <code>magrittr</code> package, which is installed automatically with <strong><code>dplyr</code></strong>. If you use RStudio, you can type the pipe with <kbd>Ctrl</kbd>
+ <kbd>Shift</kbd> + <kbd>M</kbd> if you have a PC or <kbd>Cmd</kbd> +
<kbd>Shift</kbd> + <kbd>M</kbd> if you have a Mac.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="dplyr.html#cb20-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="dplyr.html#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(driver_age <span class="sc">&gt;</span> <span class="dv">85</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="dplyr.html#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(violation, driver_gender)</span></code></pre></div>
<p>In the above, we use the pipe to send the <code>stops</code> data first through
<code>filter()</code> to keep rows where <code>driver_race</code> is Black, then through <code>select()</code>
to keep only the <code>officer_id</code> and <code>stop_date</code> columns. Since <code>%&gt;%</code> takes
the object on its left and passes it as the first argument to the function on
its right, we don’t need to explicitly include it as an argument to the
<code>filter()</code> and <code>select()</code> functions anymore.</p>
<p>If we wanted to create a new object with this smaller version of the data, we
could do so by assigning it a new name:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="dplyr.html#cb21-1" aria-hidden="true" tabindex="-1"></a>senior_drivers <span class="ot">&lt;-</span> stops <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="dplyr.html#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(driver_age <span class="sc">&gt;</span> <span class="dv">85</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="dplyr.html#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(violation, driver_gender, driver_race)</span>
<span id="cb21-4"><a href="dplyr.html#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="dplyr.html#cb21-5" aria-hidden="true" tabindex="-1"></a>senior_drivers</span></code></pre></div>
<pre><code>#&gt; # A tibble: 3 x 3
#&gt;   violation driver_gender driver_race
#&gt;   &lt;chr&gt;     &lt;chr&gt;         &lt;chr&gt;      
#&gt; 1 Seat belt male          White      
#&gt; 2 Speeding  male          White      
#&gt; 3 Seat belt male          Black</code></pre>
<p>Note that the final data frame is the leftmost part of this expression.</p>
<blockquote>
<h3>
Challenge
</h3>
<p>Using pipes, subset the <code>stops</code> data to include stops in Tunica county only and retain the columns <code>stop_date</code>, <code>driver_age</code>, and <code>violation</code>. Bonus: sort the table by driver age.</p>
</blockquote>
<!---

```r
## Answer
stops %>% 
  filter(county_name == "Tunica") %>% 
  select(stop_date, driver_age, violation) %>% 
  arrange(driver_age)
```
--->
</div>
<div id="add-new-columns" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Add new columns</h2>
<p>Frequently you’ll want to create new columns based on the values in existing columns or. For this we’ll use <code>mutate()</code>. We can also reassign values to an existing column with that function.</p>
<p>Be aware that new and edited columns will not permanently be added to the existing data frame – unless we explicitly save the output.</p>
<p>So here is an example using the <code>year()</code> function from the lubridate package to extract the year of the drivers’ birthdate:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="dplyr.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb23-2"><a href="dplyr.html#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="dplyr.html#cb23-3" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="dplyr.html#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">birth_year =</span> <span class="fu">year</span>(driver_birthdate))</span></code></pre></div>
<p>We can keep adding columns like this:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="dplyr.html#cb24-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="dplyr.html#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">birth_year =</span> <span class="fu">year</span>(driver_birthdate),</span>
<span id="cb24-3"><a href="dplyr.html#cb24-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">birth_cohort =</span> <span class="fu">floor</span>(birth_year<span class="sc">/</span><span class="dv">10</span>)<span class="sc">*</span><span class="dv">10</span>) </span></code></pre></div>
<p>We are beginning to see the power of piping. Here is a slightly expanded example, where we select the column <code>birth_cohort</code> that we have created and send it to plot:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="dplyr.html#cb25-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="dplyr.html#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">birth_year =</span> <span class="fu">year</span>(driver_birthdate),</span>
<span id="cb25-3"><a href="dplyr.html#cb25-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">birth_cohort =</span> <span class="fu">floor</span>(birth_year<span class="sc">/</span><span class="dv">10</span>)<span class="sc">*</span><span class="dv">10</span>,</span>
<span id="cb25-4"><a href="dplyr.html#cb25-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">birth_cohort =</span> <span class="fu">factor</span>(birth_cohort)) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="dplyr.html#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(birth_cohort) <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a href="dplyr.html#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>()</span></code></pre></div>
<div class="figure"><span id="fig:driver-birth-cohorts"></span>
<img src="R-data-wrangling_files/figure-html/driver-birth-cohorts-1.png" alt="Driver Birth Cohorts" width="672" />
<p class="caption">
Figure 1.1: Driver Birth Cohorts
</p>
</div>
<p>Mutate can also be used in conjunction with logical conditions. For example, we could create a new column, where we assign everyone born after the year 2000 to a group “millenial” and overyone before to “pre-millenial.”</p>
<p>In order to do this we take advantage of the <code>ifelse</code> function:</p>
<p><code>ifelse(a_logical_condition, if_true_return_this, if_false_return_this)</code></p>
<p>In conjunction with mutate, this works like this:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="dplyr.html#cb26-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="dplyr.html#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort =</span> <span class="fu">ifelse</span>(<span class="fu">year</span>(driver_birthdate) <span class="sc">&lt;</span> <span class="dv">2000</span>, <span class="st">&quot;pre-millenial&quot;</span>, <span class="st">&quot;millenial&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="dplyr.html#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(driver_birthdate, cohort)</span></code></pre></div>
<pre><code>#&gt; # A tibble: 211,211 x 2
#&gt;    driver_birthdate cohort       
#&gt;    &lt;date&gt;           &lt;chr&gt;        
#&gt;  1 1950-06-14       pre-millenial
#&gt;  2 1967-04-06       pre-millenial
#&gt;  3 1974-04-15       pre-millenial
#&gt;  4 1981-03-23       pre-millenial
#&gt;  5 1992-08-03       pre-millenial
#&gt;  6 1960-05-02       pre-millenial
#&gt;  7 1953-03-16       pre-millenial
#&gt;  8 1993-06-14       pre-millenial
#&gt;  9 1947-12-11       pre-millenial
#&gt; 10 1984-07-14       pre-millenial
#&gt; # … with 211,201 more rows</code></pre>
<p>More advanced conditional recoding can be done with <a href="https://dplyr.tidyverse.org/reference/case_when.html"><code>case_when()</code></a>.</p>
<blockquote>
<h3>
Challenge
</h3>
<p>Create a new data frame from the <code>stops</code> data that meets the following
criteria: contains only the <code>violation</code> column for female drivers of age 50 that were stopped on a Sunday. For this add a new column to your data frame called
<code>weekday_of_stop</code> containing the number of the weekday when the stop occurred. Use the <code>wday()</code> function from <code>lubridate</code> (Sunday = 1).</p>
<p>Think about how the commands should be ordered to produce this data frame!</p>
</blockquote>
<!---

```r
## Answer
stops %>% 
  filter(driver_age == 50 & driver_gender == "female") %>% 
  mutate(wds = wday(ymd(stop_date))) %>% 
  select(violation, wds) %>% 
  filter(wds == 1)
```
--->
</div>
<div id="what-is-split-apply-combine" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> What is split-apply-combine?</h2>
<p>Many data analysis tasks can be approached using the <em>split-apply-combine</em>
paradigm: split the data into groups, apply some analysis to each group, and
then combine the results.</p>
<div class="figure"><span id="fig:split-apply-combine"></span>
<img src="img/split-apply-combine.png" alt="Split - Apply - Combine" width="\textwidth" />
<p class="caption">
Figure 1.2: Split - Apply - Combine
</p>
</div>
<p><strong><code>dplyr</code></strong> makes this possible through the use of the <code>group_by()</code> function.</p>
<p><code>group_by()</code> is often used together with <code>summarize()</code>, which collapses each
group into a single-row summary of that group. <code>group_by()</code> takes as arguments
the column names that contain the <strong>categorical</strong> variables for which you want
to calculate the summary statistics. So to view the mean age for black and white drivers:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="dplyr.html#cb28-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="dplyr.html#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(driver_race) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="dplyr.html#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_age =</span> <span class="fu">mean</span>(driver_age, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>#&gt; # A tibble: 3 x 2
#&gt;   driver_race mean_age
#&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 Black           34.2
#&gt; 2 White           36.2
#&gt; 3 &lt;NA&gt;            34.5</code></pre>
<p>If we wanted to remove the line with <code>NA</code> we could insert a <code>filter()</code> in the chain:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="dplyr.html#cb31-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="dplyr.html#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(driver_race)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="dplyr.html#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(driver_race) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="dplyr.html#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_age =</span> <span class="fu">mean</span>(driver_age, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>#&gt; `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>#&gt; # A tibble: 2 x 2
#&gt;   driver_race mean_age
#&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 Black           34.2
#&gt; 2 White           36.2</code></pre>
<p>Recall that <code>is.na()</code> is a function that determines whether something is an <code>NA</code>. The <code>!</code> symbol negates the result, so we’re asking for everything that is <em>not</em> an <code>NA</code>.</p>
<p>You can also group by multiple columns:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="dplyr.html#cb34-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="dplyr.html#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(driver_race)) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="dplyr.html#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(county_name, driver_race) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="dplyr.html#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_age =</span> <span class="fu">mean</span>(driver_age, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>#&gt; `summarise()` regrouping output by &#39;county_name&#39; (override with `.groups` argument)</code></pre>
<pre><code>#&gt; # A tibble: 163 x 3
#&gt; # Groups:   county_name [82]
#&gt;    county_name driver_race mean_age
#&gt;    &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt;  1 Adams       Black           36.2
#&gt;  2 Adams       White           40.0
#&gt;  3 Alcorn      Black           34.6
#&gt;  4 Alcorn      White           33.6
#&gt;  5 Amite       Black           37.5
#&gt;  6 Amite       White           42.1
#&gt;  7 Attala      Black           36.4
#&gt;  8 Attala      White           38.6
#&gt;  9 Benton      Black           34.7
#&gt; 10 Benton      White           32.0
#&gt; # … with 153 more rows</code></pre>
<p>Once the data are grouped, you can also summarize multiple variables at the same
time (and not necessarily on the same variable). For instance, we could add a
column indicating the minimum age in each group (i.e. county):</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="dplyr.html#cb37-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="dplyr.html#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(driver_race)) <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="dplyr.html#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(county_name, driver_race) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="dplyr.html#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_age =</span> <span class="fu">mean</span>(driver_age, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb37-5"><a href="dplyr.html#cb37-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_age =</span> <span class="fu">min</span>(driver_age, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>#&gt; `summarise()` regrouping output by &#39;county_name&#39; (override with `.groups` argument)</code></pre>
<pre><code>#&gt; # A tibble: 163 x 4
#&gt; # Groups:   county_name [82]
#&gt;    county_name driver_race mean_age min_age
#&gt;    &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;
#&gt;  1 Adams       Black           36.2      16
#&gt;  2 Adams       White           40.0      16
#&gt;  3 Alcorn      Black           34.6      17
#&gt;  4 Alcorn      White           33.6      15
#&gt;  5 Amite       Black           37.5      17
#&gt;  6 Amite       White           42.1      15
#&gt;  7 Attala      Black           36.4       8
#&gt;  8 Attala      White           38.6      15
#&gt;  9 Benton      Black           34.7      18
#&gt; 10 Benton      White           32.0      18
#&gt; # … with 153 more rows</code></pre>
</div>
<div id="tallying" class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> Tallying</h2>
<p>When working with data, it is also common to want to know the number of
observations found for categorical variables. For this, <strong><code>dplyr</code></strong>
provides <code>count()</code>. For example, if we wanted to see how many traffic stops each officer recorded:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="dplyr.html#cb40-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="dplyr.html#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(officer_id)</span></code></pre></div>
<p>Bu default, count will name the column with the counts <code>n</code>. We can change this by explicitly providing a value for the <code>name</code> argument:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="dplyr.html#cb41-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="dplyr.html#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(officer_id, <span class="at">name =</span> <span class="st">&quot;n_stops&quot;</span>)</span></code></pre></div>
<p>We can optionally sort the results in descending order by adding <code>sort=TRUE</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="dplyr.html#cb42-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="dplyr.html#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(officer_id, <span class="at">name =</span> <span class="st">&quot;n_stops&quot;</span>, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><code>count()</code> calls <code>group_by()</code> transparently before counting the total number of records for each category. Similarly, we can count subgroups within groups:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="dplyr.html#cb43-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="dplyr.html#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(officer_id, violation, <span class="at">name =</span> <span class="st">&quot;n_stops&quot;</span>)</span></code></pre></div>
<p>Alternatives:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="dplyr.html#cb44-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="dplyr.html#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(officer_id) <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="dplyr.html#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tally</span>(<span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="co"># tally() requires group_by before counting</span></span>
<span id="cb44-4"><a href="dplyr.html#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="dplyr.html#cb44-5" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="dplyr.html#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(officer_id) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="dplyr.html#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="co"># n() is useful when the count is needed within a calculation</span></span>
<span id="cb44-8"><a href="dplyr.html#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code></pre></div>
<blockquote>
<h3>
Challenge
</h3>
<p>Which 5 counties were the ones with the most stops in 2013?
Hint: use the year() function from lubridate.</p>
</blockquote>
<!---

--->
</div>
<div id="joining-two-tables" class="section level2" number="1.7">
<h2><span class="header-section-number">1.7</span> Joining two tables</h2>
<p>It is not uncommon that we have our data spread out in different tables and need to bring those together for analysis. In this example we will combine the numbers of stops for black and white drivers per county together with the numbers of the black and white total population for these counties. The population data are the estimated values of the 5 year average from the 2011-2015 American Community Survey (ACS):</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="dplyr.html#cb45-1" aria-hidden="true" tabindex="-1"></a>acs <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;data/MS_acs2015_bw.csv&quot;</span>)</span></code></pre></div>
<pre><code>#&gt; Parsed with column specification:
#&gt; cols(
#&gt;   County = col_character(),
#&gt;   FIPS = col_double(),
#&gt;   black_pop = col_double(),
#&gt;   white_pop = col_double(),
#&gt;   bw_pop = col_double()
#&gt; )</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="dplyr.html#cb47-1" aria-hidden="true" tabindex="-1"></a>acs</span></code></pre></div>
<pre><code>#&gt; # A tibble: 82 x 5
#&gt;    County      FIPS black_pop white_pop bw_pop
#&gt;    &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1 Jones      28067     19711     47154  66865
#&gt;  2 Lauderdale 28075     33893     43482  77375
#&gt;  3 Pike       28113     21028     18282  39310
#&gt;  4 Hancock    28045      4172     39686  43858
#&gt;  5 Holmes     28051     15498      3105  18603
#&gt;  6 Jackson    28059     30704    101686 132390
#&gt;  7 Grenada    28043      9417     11991  21408
#&gt;  8 Scott      28123     10562     16920  27482
#&gt;  9 Wayne      28153      8015     12154  20169
#&gt; 10 Bolivar    28011     21648     11197  32845
#&gt; # … with 72 more rows</code></pre>
<p>In a first step we count all the stops per county.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="dplyr.html#cb49-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="dplyr.html#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(county_name, <span class="at">name =</span> <span class="st">&quot;n_stops&quot;</span>) </span></code></pre></div>
<pre><code>#&gt; # A tibble: 82 x 2
#&gt;    county_name n_stops
#&gt;    &lt;chr&gt;         &lt;int&gt;
#&gt;  1 Adams           942
#&gt;  2 Alcorn         3345
#&gt;  3 Amite          2921
#&gt;  4 Attala         4203
#&gt;  5 Benton          214
#&gt;  6 Bolivar        4526
#&gt;  7 Calhoun        1658
#&gt;  8 Carroll        1788
#&gt;  9 Chickasaw      3869
#&gt; 10 Choctaw         613
#&gt; # … with 72 more rows</code></pre>
<p>We will then pipe this into our next operation where we bring the two tables together. We will use <code>left_join</code>, which returns all rows from the left table, and all columns from the left and the right table. As ID, which uniquely identifies the corresponding records in each table we use the County names.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="dplyr.html#cb51-1" aria-hidden="true" tabindex="-1"></a>stops <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="dplyr.html#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(county_name, <span class="at">name =</span> <span class="st">&quot;n_stops&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="dplyr.html#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(acs, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;county_name&quot;</span> <span class="ot">=</span> <span class="st">&quot;County&quot;</span>)) </span></code></pre></div>
<pre><code>#&gt; # A tibble: 82 x 6
#&gt;    county_name n_stops  FIPS black_pop white_pop bw_pop
#&gt;    &lt;chr&gt;         &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1 Adams           942 28001     17757     12856  30613
#&gt;  2 Alcorn         3345 28003      4281     31563  35844
#&gt;  3 Amite          2921 28005      5416      7395  12811
#&gt;  4 Attala         4203 28007      8194     10649  18843
#&gt;  5 Benton          214 28009      3078      5166   8244
#&gt;  6 Bolivar        4526 28011     21648     11197  32845
#&gt;  7 Calhoun        1658 28013      3991     10103  14094
#&gt;  8 Carroll        1788 28015      3470      6702  10172
#&gt;  9 Chickasaw      3869 28017      7549      9522  17071
#&gt; 10 Choctaw         613 28019      2596      5661   8257
#&gt; # … with 72 more rows</code></pre>
<p>Now we can, for example calculate the stop rate, i.e. the number of stops per population in each county.</p>
<blockquote>
<h3>
Challenge
</h3>
<p>Which county has the highest and which one the lowest stop rate?
Use the snippet from above and pipe into the additional operations
to do this.</p>
</blockquote>
<!---

--->
<p><code>dplyr</code> join functions are generally equivalent to <code>merge</code> from the base command, but there are a few advantages:</p>
<ul>
<li>rows are kept in existing order</li>
<li>it runs faster</li>
<li>tells you what keys you’re merging by (if you don’t supply them)</li>
<li>also works with database tables.</li>
</ul>
<p><a href="https://groups.google.com/d/msg/manipulatr/OuAPC4VyfIc/Qnt8mDfq0WwJ" class="uri">https://groups.google.com/d/msg/manipulatr/OuAPC4VyfIc/Qnt8mDfq0WwJ</a></p>
<p>See <code>?dplyr::join</code> for all the possible joins.</p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>This is now also true for the base <code>read.csv</code> starting with R version 4.<a href="dplyr.html#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tidyr.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cengel/R-data-wrangling/edit/master/01-dplyr.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["R-data-wrangling.pdf", "R-data-wrangling.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
